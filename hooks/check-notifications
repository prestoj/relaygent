#!/bin/bash
# Relaygent PostToolUse hook: shows current time + checks cached notifications + context tracking
# Service watchdog logic lives in ensure-services (called below).

# Ensure background services are running (notification-poller, slack-socket, hub)
"$(dirname "$0")/ensure-services" &>/dev/null &

CACHE_FILE="/tmp/relaygent-notifications-cache.json"

# Build context string: always include time
TIME=$(date '+%H:%M:%S %Z')
CTX="Current time: $TIME"

# Read cached notifications and extract reminders + chat messages
NOTIF_INFO=$(CACHE_FILE="$CACHE_FILE" python3 -c "
import json, os
try:
    with open(os.environ['CACHE_FILE']) as f: data = json.load(f)
    parts = []
    for n in data:
        if n.get('type') == 'reminder':
            parts.append('REMINDER DUE: \"' + n.get('message', '') + '\"')
        elif n.get('type') == 'email':
            count = n.get('count', 0)
            noun = 'email' if count == 1 else 'emails'
            previews = n.get('previews', [])
            if previews:
                prev = previews[0]
                parts.append(f'{count} new {noun}: From: {prev.get(\"from\",\"?\")} Subject: {prev.get(\"subject\",\"\")}')
            else:
                parts.append(f'{count} new {noun}')
        elif n.get('type') == 'message':
            count = n.get('count', 0)
            src = n.get('source', 'chat')
            if src == 'slack':
                channels = n.get('channels', [])
                previews = []
                for ch in channels[:3]:
                    msgs = ch.get('messages', [])
                    if msgs:
                        m = msgs[-1]
                        txt = (m.get('text') or '')[:60].replace('\n',' ')
                        ch_name = ch.get('name') or '?'
                        previews.append('[#' + ch_name + '] ' + txt)
                summary = str(count) + ' unread Slack' + (': ' + ' | '.join(previews) if previews else ' message(s)')
                parts.append(summary)
            else:
                parts.append(f'{count} unread chat message(s) — check with read_messages')
    if parts:
        print(' | '.join(parts))
except Exception as e:
    import sys; print(f'WARNING: notification cache parse error: {e}', file=sys.stderr)
" 2>>/tmp/relaygent-hook-errors.log)
if [[ -n "$NOTIF_INFO" ]]; then
    CTX="$CTX | $NOTIF_INFO"
    # Auto-ack Slack messages after injecting them into context
    [[ "$NOTIF_INFO" == *"unread Slack"* ]] && date +%s.%N > ~/.relaygent/slack/.last_check_ts 2>/dev/null || true
fi

# Context fill % — check directly from JSONL (runs every tool call, no polling delay)
CONTEXT_PCT_FILE="/tmp/relaygent-context-pct"
CONTEXT_THRESHOLD=85
REPO_PATH=$(python3 -c "
import json,os
with open(os.path.expanduser('~/.relaygent/config.json')) as f: print(json.load(f)['paths']['repo'])
" 2>/dev/null)
if [[ -n "$REPO_PATH" ]]; then
    RUNS_PREFIX=$(echo "${REPO_PATH}/harness/runs" | sed 's|/|-|g')
    LATEST_JSONL=$(ls -t ~/.claude/projects/${RUNS_PREFIX}*/*.jsonl 2>/dev/null | head -1)
fi
if [[ -n "$LATEST_JSONL" ]]; then
    FILL_PCT=$(tail -c 65536 "$LATEST_JSONL" 2>/dev/null | python3 -c "
import sys, json
data = sys.stdin.buffer.read().decode('utf-8', errors='ignore')
for line in reversed(data.strip().split(chr(10))):
    try:
        entry = json.loads(line)
        if entry.get('type') == 'assistant':
            usage = entry.get('message', {}).get('usage', {})
            if usage:
                total = usage.get('input_tokens', 0) + usage.get('output_tokens', 0) + usage.get('cache_creation_input_tokens', 0) + usage.get('cache_read_input_tokens', 0)
                print(int(total / 200000 * 100))
                break
    except: continue
" 2>/dev/null)
    if [[ -n "$FILL_PCT" ]]; then
        echo "$FILL_PCT" > "${CONTEXT_PCT_FILE}.tmp" && mv "${CONTEXT_PCT_FILE}.tmp" "$CONTEXT_PCT_FILE"
        if [[ "$FILL_PCT" -ge "$CONTEXT_THRESHOLD" ]]; then
            CTX="$CTX | CONTEXT ${FILL_PCT}% — AUTO-COMPACT at 95% will erase context. Wrap up NOW: rewrite HANDOFF.md, update MEMORY.md, commit KB, then stop."
        fi
    fi
fi

export _HOOK_CTX="$CTX"
HOOK_FILE="/tmp/relaygent-hook-output.json"
_TOOL_NAME="${TOOL_NAME:-unknown}" _FILL="${FILL_PCT:-0}" python3 -c "
import json,os,time
data={'context':os.environ['_HOOK_CTX'],'tool':os.environ['_TOOL_NAME'],'fill_pct':int(os.environ['_FILL'] or 0),'ts':time.time()}
with open('${HOOK_FILE}.tmp','w') as f: json.dump(data,f)
os.rename('${HOOK_FILE}.tmp','${HOOK_FILE}')
" 2>/dev/null
python3 -c "import json,os; print(json.dumps({'hookSpecificOutput':{'hookEventName':'PostToolUse','additionalContext':os.environ['_HOOK_CTX']}}))"
