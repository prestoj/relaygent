#!/bin/bash
# Ensure background services are running (notification-poller, slack-socket, hub).
# Called by check-notifications hook. Idempotent with crash-loop backoff.

REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"
CFG="$HOME/.relaygent/config.json"

# --- Notification poller ---
POLLER_SCRIPT="$(dirname "$0")/notification-poller"
POLLER_CRASH_FILE="/tmp/relaygent-poller-last-start"
if ! pgrep -f "relaygent.*notification-poller" &>/dev/null; then
    if [[ -x "$POLLER_SCRIPT" ]]; then
        local_ok=true
        if [[ -f "$POLLER_CRASH_FILE" ]]; then
            last_start=$(cat "$POLLER_CRASH_FILE" 2>/dev/null || echo 0)
            now=$(date +%s)
            (( now - last_start < 10 )) && local_ok=false
        fi
        if [[ "$local_ok" = true ]]; then
            date +%s > "$POLLER_CRASH_FILE"
            nohup "$POLLER_SCRIPT" &>/dev/null &
            disown
        fi
    fi
fi

# --- Slack socket listener ---
SOCKET_SCRIPT="$REPO_DIR/notifications/slack-socket-listener.mjs"
SOCKET_CACHE="/tmp/relaygent-slack-socket-cache.json"
SOCKET_CRASH_FILE="/tmp/relaygent-socket-last-start"
SOCKET_STALE_MINS=15
# Kill stale listener (running but cache not updated in >15 min â€” silent dead connection)
if pgrep -f "slack-socket-listener" &>/dev/null; then
    cache_updated=$(python3 -c "
import json,time,os
try:
    d=json.load(open('$SOCKET_CACHE'))
    age=(time.time()*1000-d.get('updated',0))/60000
    print('stale' if age>$SOCKET_STALE_MINS else 'ok')
except: print('ok')
" 2>/dev/null)
    if [[ "$cache_updated" = "stale" ]]; then
        stale_ok=true
        if [[ -f "$SOCKET_CRASH_FILE" ]]; then
            sock_last=$(cat "$SOCKET_CRASH_FILE" 2>/dev/null || echo 0)
            sock_now=$(date +%s)
            (( sock_now - sock_last < 60 )) && stale_ok=false
        fi
        if [[ "$stale_ok" = true ]]; then
            pkill -f "slack-socket-listener" 2>/dev/null || true
            sleep 0.5
        fi
    fi
fi
if ! pgrep -f "slack-socket-listener" &>/dev/null; then
    if [[ -f "$SOCKET_SCRIPT" ]]; then
        sock_ok=true
        if [[ -f "$SOCKET_CRASH_FILE" ]]; then
            sock_last=$(cat "$SOCKET_CRASH_FILE" 2>/dev/null || echo 0)
            sock_now=$(date +%s)
            (( sock_now - sock_last < 30 )) && sock_ok=false
        fi
        if [[ "$sock_ok" = true ]]; then
            date +%s > "$SOCKET_CRASH_FILE"
            nohup node "$SOCKET_SCRIPT" >> /tmp/relaygent-socket-listener.log 2>&1 &
            disown
        fi
    fi
fi

# --- Hub auto-restart ---
HP=$(python3 -c "import json; print(json.load(open('$CFG'))['hub']['port'])" 2>/dev/null || echo 8080)
hub_alive=false
curl -sf --max-time 1 "http://127.0.0.1:$HP/api/health" >/dev/null 2>&1 && hub_alive=true
if [ "$hub_alive" = false ] && [ -f "$REPO_DIR/hub/build/handler.js" ]; then
    HUB_CRASH_FILE="/tmp/relaygent-hub-last-start"
    hub_ok=true
    if [[ -f "$HUB_CRASH_FILE" ]]; then
        h_last=$(cat "$HUB_CRASH_FILE" 2>/dev/null || echo 0)
        (( $(date +%s) - h_last < 30 )) && hub_ok=false
    fi
    if [[ "$hub_ok" = true ]]; then
        date +%s > "$HUB_CRASH_FILE"
        if [ "$(uname)" = "Darwin" ] && launchctl list 2>/dev/null | grep -q com.relaygent.hub; then
            launchctl start com.relaygent.hub 2>/dev/null
        elif [ "$(uname)" = "Linux" ] && systemctl --user is-enabled relaygent-hub &>/dev/null; then
            systemctl --user start relaygent-hub 2>/dev/null
        else
            NP=$(python3 -c "import json; print(json.load(open('$CFG'))['services']['notifications']['port'])" 2>/dev/null || echo 8083)
            KD=$(python3 -c "import json; print(json.load(open('$CFG'))['paths']['kb'])" 2>/dev/null || echo "$REPO_DIR/knowledge/topics")
            DD=$(python3 -c "import json; print(json.load(open('$CFG'))['paths']['data'])" 2>/dev/null || echo "$REPO_DIR/data")
            mkdir -p "$REPO_DIR/logs"
            PORT="$HP" RELAY_STATUS_FILE="$DD/relay-status.json" RELAYGENT_KB_DIR="$KD" \
                RELAYGENT_DATA_DIR="$DD" RELAYGENT_NOTIFICATIONS_PORT="$NP" \
                nohup node "$REPO_DIR/hub/ws-server.mjs" >> "$REPO_DIR/logs/relaygent-hub.log" 2>&1 &
            echo $! > "$HOME/.relaygent/hub.pid"
        fi
    fi
fi
