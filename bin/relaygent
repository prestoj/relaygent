#!/usr/bin/env bash
set -euo pipefail
_SELF="${BASH_SOURCE[0]}"; while [[ -L "$_SELF" ]]; do _d="$(cd "$(dirname "$_SELF")" && pwd)"; _l="$(readlink "$_SELF")"; [[ "$_l" == /* ]] && _SELF="$_l" || _SELF="$_d/$_l"; done
SCRIPT_DIR="$(cd "$(dirname "$_SELF")/.." && pwd)"

CYAN='\033[0;36m'; NC='\033[0m'; RED='\033[0;31m'

case "${1:-help}" in
    start)   bash "$SCRIPT_DIR/harness/scripts/start.sh" ;;
    stop)    bash "$SCRIPT_DIR/harness/scripts/stop.sh"; exit 0 ;;
    restart) bash "$SCRIPT_DIR/harness/scripts/stop.sh"; sleep 1; bash "$SCRIPT_DIR/harness/scripts/start.sh" ;;
    status)
        source "$SCRIPT_DIR/harness/scripts/lib.sh"
        load_config
        echo -e "${CYAN}Relaygent Status${NC}"
        for svc in Relay:relay Hub:hub Notifications:notifications Slack-socket:slack-socket Email-poller:email-poller; do
            check_process "${svc%%:*}" "${svc##*:}"
        done
        [ "$(uname)" = "Darwin" ] && { pgrep -x Hammerspoon >/dev/null 2>&1 && echo -e "  Hammerspoon: ${GREEN}running${NC}" || echo -e "  Hammerspoon: ${RED}stopped${NC}"; } \
            || { check_process "Computer-use" "computer-use"; check_process "Xvfb" "xvfb"; }
        ;;
    logs)
        SVC="${2:-}"; [ -n "$SVC" ] && F="$SCRIPT_DIR/logs/relaygent-$SVC.log" || F="$SCRIPT_DIR/logs/relaygent*.log"
        tail -f $F 2>/dev/null || echo -e "${RED}No logs found${NC}"
        ;;
    orient|check|update|health|clean-logs) bash "$SCRIPT_DIR/harness/scripts/$1.sh" "${@:2}" ;;
    archive-linear) node "$SCRIPT_DIR/linear/auto-archive.mjs" "${@:2}" ;;
    set-password) node "$SCRIPT_DIR/hub/set-password.mjs" "${@:2}" ;;
    help|--help|-h|*)
        echo -e "${CYAN}Usage:${NC} relaygent <command>\n"
        printf "  %-17s %s\n" \
            "start" "Launch agent, dashboard, and all services" \
            "stop" "Stop everything" \
            "restart" "Restart all services" \
            "status" "Show what's running" \
            "logs [service]" "Tail live service logs" \
            "orient" "Quick system status snapshot" \
            "check" "Diagnose configuration" \
            "health" "Ping all services and report status" \
            "update" "Pull latest, rebuild, restart" \
            "clean-logs" "Remove old/rotated logs (--dry-run, --days N)" \
            "set-password" "Set/remove hub dashboard auth (--remove)" \
            "archive-linear" "Archive old Linear issues (--dry-run, --days N)"
        ;;
esac
