#!/usr/bin/env bash
set -euo pipefail
_SELF="${BASH_SOURCE[0]}"; while [[ -L "$_SELF" ]]; do _d="$(cd "$(dirname "$_SELF")" && pwd)"; _l="$(readlink "$_SELF")"; [[ "$_l" == /* ]] && _SELF="$_l" || _SELF="$_d/$_l"; done
SCRIPT_DIR="$(cd "$(dirname "$_SELF")/.." && pwd)"

CYAN='\033[0;36m'; NC='\033[0m'; RED='\033[0;31m'

show_help() {
    echo -e "${CYAN}Usage:${NC} relaygent <command>\n"
    printf "  %-19s %s\n" \
        "setup" "Interactive first-time setup wizard" \
        "start" "Launch agent, dashboard, and all services" \
        "stop" "Stop everything" \
        "restart" "Restart all services" \
        "status" "Show what's running" \
        "stats" "Session history, errors, and context usage" \
        "test [suite]" "Run test suite (harness, hub, notifications, ...)" \
        "logs [service]" "View logs (-f follow, -n lines, --list)" \
        "orient" "Quick system status snapshot" \
        "check" "Diagnose configuration" \
        "health" "Ping all services and report status" \
        "update" "Pull latest, rebuild, restart" \
        "digest" "Daily summary of PRs, commits, and status" \
        "cleanup" "Free disk: old sessions, caches, logs (--dry-run)" \
        "changelog" "Show recent merged PRs and commits (--days N)" \
        "clean-logs" "Remove old/rotated logs (--dry-run, --days N)" \
        "install-services" "Set up auto-restart services (macOS/Linux)" \
        "set-password" "Set/remove hub dashboard auth (--remove)" \
        "mcp" "Manage MCP servers (list, add, remove)" \
        "archive-linear" "Archive old Linear issues (--dry-run, --days N)" \
        "chat <msg>" "Send a message to the agent (--read to view)" \
        "open [page]" "Open hub dashboard in browser" \
        "completions" "Output shell completions (eval in .bashrc/.zshrc)" \
        "version" "Show version info"
}

case "${1:-help}" in
    setup)   bash "$SCRIPT_DIR/setup.sh" ;;
    chat)    bash "$SCRIPT_DIR/harness/scripts/chat.sh" "${@:2}" ;;
    start)   bash "$SCRIPT_DIR/harness/scripts/start.sh" ;;
    stop)    bash "$SCRIPT_DIR/harness/scripts/stop.sh"; exit 0 ;;
    restart) bash "$SCRIPT_DIR/harness/scripts/stop.sh"; sleep 1; bash "$SCRIPT_DIR/harness/scripts/start.sh" ;;
    status)
        source "$SCRIPT_DIR/harness/scripts/lib.sh"
        load_config
        echo -e "${CYAN}Relaygent Status${NC}"
        check_process "Relay" "relay"
        check_process "Hub" "hub" "$HUB_PORT"
        check_process "Notifications" "notifications" "$NOTIF_PORT"
        check_process "Slack-socket" "slack-socket"
        check_process "Email-poller" "email-poller"
        [ "$(uname)" = "Darwin" ] && { pgrep -x Hammerspoon >/dev/null 2>&1 && echo -e "  Hammerspoon: ${GREEN}running${NC}" || echo -e "  Hammerspoon: ${RED}stopped${NC}"; } \
            || { check_process "Computer-use" "computer-use"; check_process "Xvfb" "xvfb"; }
        # Agent state + context fill
        STATUS_FILE="${DATA_DIR:-$SCRIPT_DIR/data}/relay-status.json"
        if [ -f "$STATUS_FILE" ]; then
            read -r AGENT_ST UPDATED <<< "$(python3 -c "
import json,sys
from datetime import datetime as D
d=json.load(open('$STATUS_FILE'))
s=d.get('status','unknown')
u=d.get('updated','')
try:
 dt=D.fromisoformat(u); elapsed=int((D.now(dt.tzinfo)-dt).total_seconds())
 h,m=divmod(elapsed//60,60); t=f'{h}h{m:02d}m' if h else f'{m}m'
except: t='?'
print(s,t)
" 2>/dev/null || echo "unknown ?")"
            case "$AGENT_ST" in
                working)  echo -e "\n  Agent: ${GREEN}$AGENT_ST${NC} (${UPDATED} in state)" ;;
                sleeping) echo -e "\n  Agent: ${YELLOW}$AGENT_ST${NC} (${UPDATED})" ;;
                *)        echo -e "\n  Agent: $AGENT_ST" ;;
            esac
        fi
        PCT_FILE="/tmp/relaygent-context-pct"
        if [ -f "$PCT_FILE" ]; then
            PCT=$(cat "$PCT_FILE" 2>/dev/null || echo "0")
            if [ "${PCT:-0}" -ge 85 ] 2>/dev/null; then
                echo -e "  Context: ${RED}${PCT}%${NC} (wrapping up)"
            elif [ "${PCT:-0}" -ge 50 ] 2>/dev/null; then
                echo -e "  Context: ${YELLOW}${PCT}%${NC}"
            else
                echo -e "  Context: ${PCT}%"
            fi
        fi
        ;;
    logs) bash "$SCRIPT_DIR/harness/scripts/logs.sh" "${@:2}" ;;
    stats) python3 "$SCRIPT_DIR/harness/scripts/stats.py" "${@:2}" ;;
    test) bash "$SCRIPT_DIR/test.sh" "${@:2}" ;;
    mcp|orient|check|update|health|clean-logs|cleanup|changelog|digest) bash "$SCRIPT_DIR/harness/scripts/$1.sh" "${@:2}" ;;
    archive-linear) node "$SCRIPT_DIR/linear/auto-archive.mjs" "${@:2}" ;;
    set-password) node "$SCRIPT_DIR/hub/set-password.mjs" "${@:2}" ;;
    install-services)
        [ "$(uname)" = "Darwin" ] && bash "$SCRIPT_DIR/scripts/install-launchagents.sh" "${@:2}" \
            || bash "$SCRIPT_DIR/scripts/install-systemd-services.sh" "${@:2}" ;;
    open)
        source "$SCRIPT_DIR/harness/scripts/lib.sh"; load_config_soft
        URL="http://localhost:${HUB_PORT:-8080}${2:+/$2}"
        if [ "$(uname)" = "Darwin" ]; then open "$URL"
        elif command -v xdg-open >/dev/null 2>&1; then xdg-open "$URL"
        else echo "$URL"; fi
        ;;
    completions) cat "$SCRIPT_DIR/scripts/completions.sh" ;;
    version)
        COMMIT=$(git -C "$SCRIPT_DIR" rev-parse --short HEAD 2>/dev/null || echo "unknown")
        DATE=$(git -C "$SCRIPT_DIR" log -1 --format=%cs 2>/dev/null || echo "unknown")
        echo "relaygent ($COMMIT, $DATE)"
        ;;
    help|--help|-h) show_help ;;
    *) echo -e "${RED}Unknown command: $1${NC}" >&2; echo; show_help >&2; exit 1 ;;
esac
