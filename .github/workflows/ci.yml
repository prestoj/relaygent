name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test-harness:
    name: Harness tests (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: pip install pytest
      - name: Run harness + computer-use tests
        run: pytest tests/harness/ tests/computer-use/ -v

  test-notifications:
    name: Notifications tests (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: pip install pytest -r notifications/requirements.txt
      - name: Run notifications tests
        run: pytest tests/notifications/ -v

  lint-python:
    name: Python syntax check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check syntax
        run: find harness computer-use -name "*.py" -not -name "test_*" -not -path "*/__pycache__/*" | xargs python -m py_compile

  test-secrets:
    name: Secrets vault tests (JS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install secrets dependencies
        run: npm install --prefix secrets
      - name: Run vault tests
        run: node --test tests/secrets/test_vault.mjs

  test-email:
    name: Email tests (JS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install email dependencies
        run: npm install --prefix email
      - name: Run email tests
        run: node --test tests/email/test_email_poller.mjs tests/email/test_gmail_client.mjs

  test-slack:
    name: Slack tests (JS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install slack dependencies
        run: npm install --prefix slack
      - name: Run slack tests
        run: node --test tests/slack/test_slack_helpers.mjs tests/slack/test_slack_client.mjs

  lint-js:
    name: JS syntax check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Check syntax (all .mjs files)
        run: find secrets slack notifications -name "*.mjs" -not -path "*/node_modules/*" | xargs -I{} node --check {}

  build-hub:
    name: Hub build (Svelte)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install hub dependencies
        run: npm install --prefix hub
      - name: Build hub
        run: npm run build --prefix hub

  test-hub:
    name: Hub tests (JS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install hub dependencies
        run: npm install --prefix hub
      - name: Symlink hub node_modules for test resolution
        run: ln -sfn hub/node_modules tests/hub/node_modules
      - name: Run hub tests
        run: node --import=tests/hub/helpers/kit-loader.mjs --test tests/hub/*.test.js

  check-line-limits:
    name: File line limit (200)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check files under 200 lines
        run: |
          status=0
          for f in harness/*.py computer-use/*.py slack/*.mjs secrets/*.mjs notifications/*.py hub/src/routes/**/*.svelte; do
            [ -f "$f" ] || continue
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 200 ]; then
              echo "FAIL: $f has $lines lines (limit: 200)"
              status=1
            fi
          done
          exit $status
